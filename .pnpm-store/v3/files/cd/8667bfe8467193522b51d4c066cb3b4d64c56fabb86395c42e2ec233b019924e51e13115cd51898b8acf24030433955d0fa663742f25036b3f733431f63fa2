"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CommandFactory = void 0;
const core_1 = require("@nestjs/core");
const cosmiconfig_1 = require("cosmiconfig");
const command_root_module_1 = require("./command-root.module");
const command_runner_module_1 = require("./command-runner.module");
const command_runner_service_1 = require("./command-runner.service");
class CommandFactory {
    static async run(rootModule, optionsOrLogger) {
        const app = await this.runApplication(rootModule, optionsOrLogger);
        await app.close();
    }
    static async runWithoutClosing(rootModule, optionsOrLogger) {
        return this.runApplication(rootModule, optionsOrLogger);
    }
    static async runApplication(rootModule, optionsOrLogger = false) {
        const options = this.getOptions(optionsOrLogger);
        const imports = [rootModule];
        let pluginsAvailable = false;
        if (options.usePlugins) {
            pluginsAvailable = await this.registerPlugins(options.cliName, imports);
        }
        const commandRunnerModule = this.createCommandModule(imports, Object.assign(Object.assign({}, options), { pluginsAvailable }));
        const app = await core_1.NestFactory.createApplicationContext(commandRunnerModule, {
            logger: options.logger,
        });
        const runner = app.get(command_runner_service_1.CommandRunnerService);
        await runner.run();
        return app;
    }
    static createCommandModule(imports, options) {
        return command_runner_module_1.CommandRunnerModule.forModule({ module: command_root_module_1.CommandRootModule, imports }, options);
    }
    static getOptions(optionsOrLogger) {
        let logger;
        let tempHandler;
        let usePlugins = false;
        let cliName = 'nest-commander';
        if (this.isFactoryOptionsObject(optionsOrLogger)) {
            ({
                logger,
                errorHandler: tempHandler,
                cliName = cliName,
                usePlugins = usePlugins,
            } = optionsOrLogger);
        }
        else {
            logger = optionsOrLogger;
        }
        return { logger, errorHandler: tempHandler, usePlugins, cliName };
    }
    static isFactoryOptionsObject(loggerOrOptions) {
        return !(Array.isArray(loggerOrOptions) ||
            loggerOrOptions === false ||
            !!loggerOrOptions.log);
    }
    static async registerPlugins(cliName, imports) {
        var _a;
        const pluginExplorer = (0, cosmiconfig_1.cosmiconfig)(cliName, {
            searchPlaces: [
                `.${cliName}rc`,
                `.${cliName}rc.json`,
                `.${cliName}rc.yaml`,
                `.${cliName}rc.yml`,
                `${cliName}.json`,
                `${cliName}.yaml`,
                `${cliName}.yml`,
            ],
        });
        const pluginConfig = await pluginExplorer.search();
        if (!pluginConfig) {
            return false;
        }
        for (const pluginPath of (_a = pluginConfig === null || pluginConfig === void 0 ? void 0 : pluginConfig.config.plugins) !== null && _a !== void 0 ? _a : []) {
            // eslint-disable-next-line @typescript-eslint/no-var-requires
            const plugin = require(require.resolve(pluginPath, { paths: [process.cwd()] }));
            imports === null || imports === void 0 ? void 0 : imports.push(plugin.default);
        }
        return true;
    }
}
exports.CommandFactory = CommandFactory;
//# sourceMappingURL=command.factory.js.map